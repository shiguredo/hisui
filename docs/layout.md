# レイアウト機能

Hisui では、レイアウトを定義した JSON ファイルを使うことで、複数映像ソースを合成する際の配置を細かく指定できます。
また、レイアウト JSON では、映像ソースの配置以外に、映像や音声のエンコード設定も指定できます。

[`hisui compose`](./compose_command.md) コマンドの場合は、以下のように `-l` オプションでレイアウトファイルを指定できます：

```console
$ hisui compose -l /path/to/layout.json /path/to/archive/RECORDING_ID/
```

レイアウトファイルを指定しない場合は [layout-examples/compose-default.json](../layout-examples/compose-default.json) が使用されます。

## レイアウト JSON の概要

レイアウト JSON ではおおまかには、以下が指定できます:
- 音声の合成に使用するファイル一覧（未指定時には音声なし合成）
- 映像の合成に使用するファイル一覧（未指定時には映像なし合成）
- 合成後の音声のエンコードに使用するコーデックとビットレート
- 合成後の映像のエンコードに使用するコーデックとビットレート、エンコーダーに固有のエンコードパラメーター
- 映像の合成レイアウト

具体的に指定可能な項目については [レイアウト JSON の仕様](./layout_spec.md) を参照してください。

また、映像の合成では、柔軟にレイアウト（各映像ソースをどう配置するか）が指定できるようになっています。
こちらも詳細は [リージョン（映像の配置方法指定）について](./layout_region.md) が詳しいですが、
以降ではいくつかの例を記載しています。

## レイアウトの例: グリッド（デフォルトレイアウト）

以下は [layout-examples/compose-default.json](../layout-examples/compose-default.json) でも採用されている、
一番ベーシックな、配信者の映像をグリッド状に配置するレイアウト JSON の例です：

```json
{
  "audio_sources": [
    "archive-*.json"
  ],
  "video_layout": {
    "main": {
      "max_columns": 3,
      "max_rows": 2,
      "video_sources": [
        "archive-*.json"
      ]
    }
  },
  "resolution": "960x480"
}
```

JSON の各項目の概要は以下の通りです:

- `audio_sources`: 音声合成に使用するソースファイル一覧です
  - `archive-*.json` というワイルドカード指定により、録画ディレクトリ内の全ての配信者の音声が合成されます
- `video_layout`: 映像のレイアウト定義です
  - `main`: 映像のレイアウトは「リージョン」という単位で指定しますが、その各リージョンの名前です（任意の名前が指定可能）
    - `max_columns`: リージョン内のグリッドの最大列数です（省略時は上限なし）
    - `max_rows`: リージョン内のグリッドの最大行数です（省略時は上限なし）
    - `video_sources`: 映像合成に使用するソースファイル一覧です
- `resolution`: 合成後の映像の解像度です

ここでは `main` という名前のリージョンを一つだけ定義しています。
リージョン内に各映像ソースを配置するグリッドの形状は、
おおまかには `max_columns` および `max_rows` と映像ソースの数によって決定されます。
今回の設定では、最大で `3x2` のグリッドが形成されることになります。

### 合成結果のイメージ

配信者が4人いる場合の合成結果のイメージは以下の通りです（2行3列のグリッド）：

```
┌─────────────────────────────────────────────────────┐
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │
│  │   Source A  │  │   Source B  │  │   Source C  │  │
│  │             │  │             │  │             │  │
│  │             │  │             │  │             │  │
│  └─────────────┘  └─────────────┘  └─────────────┘  │
│                                                     │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │
│  │   Source D  │  │    Empty    │  │    Empty    │  │
│  │             │  │             │  │             │  │
│  │             │  │             │  │             │  │
│  └─────────────┘  └─────────────┘  └─────────────┘  │
└─────────────────────────────────────────────────────┘
```

このグリッドレイアウトでは、最大6つのセル（2行×3列）が利用可能で、配信者が4人の場合は上記のような配置になります。

もし配信者が6人を超える場合は、`reuse` という項目の設定に従って表示する映像ソースが決定されます。
グリッドの行列数の決定方法や、より詳細な配置ルールについては [リージョン（映像の配置方法指定）について](./layout_region.md) を参照してください。

このデフォルトレイアウトは、参加者数が適度で、全員の映像を同じサイズで表示したい会議録画などに適しています。

## レイアウトの例: TODO

## レイアウトの例: TODO
