# リージョンについて

TOC:
- リージョンの概要・概念
  - リージョン
  - セル
  - グリッド
  - 映像ソース
    - 開始時刻、終了時刻、コネクション ID （分割録画の時に重要）
    - 分割録画の扱い
  - XY 座標のオリジン
  - Z 座標について
- グリッドの行列サイズの決定方法
- セルへのソースの割り当て方法
  - セルの優先度 (同一セルに複数ソースが割り当てられた場合の優先度決定)
  - cells_excluded について
- 全体の解像度の決定方法
- リージョンの解像度の決定方法
- セルの解像度の決定方法
- 枠線（ボーダー）の扱い
- trim の扱い

## リージョンの概要

**リージョン**は、Hisui の映像合成における基本的な配置単位です。
一つのリージョン内では、複数の映像ソースを格子状（グリッド）に配置して表示できます。

### 基本概念

#### リージョン

映像合成において、特定の位置とサイズを持つ映像表示領域です。各リージョンは以下の属性を持ちます：
- **位置**: X 座標、Y 座標で指定される配置位置
- **サイズ**: 幅と高さ（ピクセル単位）
- **重ね順**: Z 座標による前後関係の指定
- **映像ソース一覧**: そのリージョンに表示する映像ファイルの指定

#### セル

リージョン内のグリッドを構成する個々の区画です。
各セルには一つの映像ソースが割り当てられ、映像が表示されます。
セルのサイズは、リージョンのサイズとグリッドの行列数から自動的に計算されます。

#### グリッド

リージョン内でのセルの配置パターンです。
行数と列数で構成され、映像ソースの数や `max_rows`、`max_columns` の設定に基づいて自動的に決定されます。

#### 映像ソース

実際に表示される映像データです。
各映像ソースには以下の情報が含まれます：
- **コネクション ID**: 配信者を識別するための ID（分割録画の際に重要）
- **開始時刻・終了時刻**: 映像が表示される時間範囲
- **分割録画の扱い**: 同一コネクション ID の複数ファイルは自動的に連結して処理されます

#### XY 座標のオリジン

座標系の原点は画面の**左上角**です。
X 座標は右方向、Y 座標は下方向が正の値となります。

#### Z 座標の扱い

Z 座標は、複数のリージョンが重なり合う場合の描画順序を決定します。
値が小さいリージョンほど奥（背景側）に、値が大きいリージョンほど手前（前景側）に描画されます。

### 複数リージョンの利用例

複数のリージョンを組み合わせることで、Picture-in-Picture のような複雑なレイアウトを実現できます：

```json
{
  "video_layout": {
    "main": {
      "video_sources": ["presenter.json"],
      "width": 1280, "height": 720,
      "x_pos": 0, "y_pos": 0, "z_pos": 0
    },
    "participants": {
      "video_sources": ["participant-*.json"],
      "max_columns": 4, "max_rows": 1,
      "width": 640, "height": 120,
      "x_pos": 320, "y_pos": 580, "z_pos": 10
    }
  }
}
```

この例では、`main` リージョンで発表者の映像を大きく表示し、`participants` リージョンで参加者の映像を小さく重ね合わせて表示しています。

## グリッドの行列サイズの決定方法

各リージョン内でのグリッドの行数と列数は、映像ソースの数と制約設定に基づいて自動的に決定されます。
決定処理は以下の手順で行われます。

### 1. 最大同時ソース数の算出

まず、そのリージョンで同時に表示が必要となる映像ソースの最大数を算出します。
これには、映像ソースの時間的な重複と除外セル（`cells_excluded`）の設定が考慮されます。

TODO: `cells_excluded` がどう考慮されるのかはもう少し詳しく書く

### 2. 基本グリッドサイズの決定

制約がない場合の理想的な行列数を以下の方針で決定します：
- 最大同時ソース数を保持可能なサイズを確保する
- できるだけ正方形に近い配置にする
- ただし、列数は行数よりも1つ多くても許容する

**例**: 5つのソースがある場合

```
理想的な配置: 2 行 × 3 列 = 6 セル (5 つのソースを収容可能)

┌─────┬─────┬─────┐
│Src1 │Src2 │Src3 │
├─────┼─────┼─────┤
│Src4 │Src5 │Empty│
└─────┴─────┴─────┘
```

### 3. 制約の適用

`max_rows` と `max_columns` の設定に基づいて調整を行います：

#### ケース1: 制約内に収まる場合

制約を満たしている場合は、基本グリッドサイズをそのまま使用します。

#### ケース2: 片方の制約のみ超過する場合

超過している側を制約値に調整し、もう片方を必要に応じて拡張します。

**例**: `max_columns = 2` の制約がある場合（5 つのソース）
```
調整後: 3行 × 2列 = 6セル

┌─────┬─────┐
│Src1 │Src2 │
├─────┼─────┤
│Src3 │Src4 │
├─────┼─────┤
│Src5 │Empty│
└─────┴─────┘
```

#### ケース3: 両方の制約を超過する場合
正方形により近くなる方の制約を優先して調整します。

**例**: `max_rows = 2`, `max_columns = 2` の場合（5 つのソース）
```
制約適用後: 2 行 × 2 列 = 4 セル
（1 つのソースは表示されないか、reuse 設定に従って処理される）

┌─────┬─────┐
│Src1 │Src2 │
├─────┼─────┤
│Src3 │Src4 │
└─────┴─────┘
```

### 4. 決定アルゴリズムの詳細

具体的な決定ロジックは以下の通りです：

```
1. sqrt(最大同時ソース数) の切り上げを列数の初期値とする
2. 行数 = max(列数 - 1, 1) とする
3. 行数 × 列数 < 最大同時ソース数の場合、行数を1増やす

4. 制約チェック:
   - 両方満たす → 完了
   - 行のみ超過 → 行を max_rows に設定、列を再計算
   - 列のみ超過 → 列を max_columns に設定、行を再計算
   - 両方超過 → より小さい制約値を基準に調整
```

TODO: このセクションは不要かも

### 5. 実際の例

#### 例 1: 基本的なケース
```json
{
  "video_sources": ["user1.json", "user2.json", "user3.json"]
}
```

```
3 つのソース → 2 行 × 2 列 = 4 セル

┌──────┬──────┐
│User1 │User2 │
├──────┼──────┤
│User3 │Empty │
└──────┴──────┘
```

#### 例 2: 制約ありのケース

```json
{
  "video_sources": ["user*.json"],  // 6 つのファイルにマッチするとする
  "max_columns": 3,
  "max_rows": 2
}
```

```
6 つのソース、制約: 3 列×2 行 → 2 行 × 3 列 = 6 セル

┌──────┬──────┬──────┐
│User1 │User2 │User3 │
├──────┼──────┼──────┤
│User4 │User5 │User6 │
└──────┴──────┴──────┘
```

#### 例 3: 制約による制限ケース
```json
{
  "video_sources": ["user*.json"],  // 8 つのファイルにマッチするとする
  "max_columns": 2,
  "max_rows": 2,
  "reuse": "show_oldest"
}
```

```
8 つのソース、制約: 2 列 × 2 行 → 2 行 × 2 列 = 4 セル
（reuse 設定により、4 つ以上のソースは時間に応じて切り替わる）

┌──────┬──────┐
│User1 │User2 │
├──────┼──────┤
│User3 │User4 │
└──────┴──────┘
```

このようにして決定されたグリッドの行列数は、セルのサイズ計算やソースの割り当て処理で使用されます。
