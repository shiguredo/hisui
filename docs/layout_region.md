# リージョンについて

## リージョンの概要

**リージョン**は、Hisui の映像合成における基本的な配置単位です。
一つのリージョン内では、複数の映像ソースを格子状（グリッド）に配置して表示できます。
また複数のリージョンを活用することで、複雑な映像のレイアウトも表現することができます。

レイアウト JSON では以下のように `video_layout` を使ってリージョンを定義します：

```json
{
  "video_layout": {
    "main": {
      "video_sources": ["archive-*.json"],
      "width": 640,
      "height": 480,
      "max_columns": 3,
      "max_rows": 2
    }
  }
}
```

この例では `main` というリージョンが定義されています。

以降では、リージョンの基礎概念や詳細の仕様について記述しています。

なお JSON 内の個々の項目についての説明は [レイアウトの仕様](./layout_spec.md) が詳しいため、そちらも参照してください。

## 基本概念

### リージョン

映像合成において、特定の位置とサイズを持つ映像表示領域です。各リージョンは以下の属性を持ちます：
- **位置**: X 座標、Y 座標で指定される配置位置
  - 座標系の原点は画面の**左上角**です。
  - X 座標は右方向、Y 座標は下方向が正の値となります。
- **サイズ**: 幅と高さ（ピクセル単位）
- **重ね順**: Z 座標による前後関係の指定
  - Z 座標は、複数のリージョンが重なり合う場合の描画順序を決定します
  - 値が小さいリージョンほど奥（背景側）に、値が大きいリージョンほど手前（前景側）に描画されますk。
- **映像ソース一覧**: そのリージョンに表示する映像ファイルの指定

### セル

リージョン内のグリッドを構成する個々の区画です。
各セルには一つの映像ソースが割り当てられ、映像が表示されます。
通常、セルのサイズは、リージョンのサイズとグリッドの行列数から自動的に計算されます。

グリッドの各セルには、**左上から右下に向かって行ごとに順番に** 0 始まりのインデックス番号が振られます。

例: 2 行 × 3 列のグリッドの場合
```
┌─────┬─────┬─────┐
│  0  │  1  │  2  │
├─────┼─────┼─────┤
│  3  │  4  │  5  │
└─────┴─────┴─────┘
```

このインデックス番号は、`cells_excluded` でセルを除外する際に使用されます。

### グリッド

リージョン内でのセルの配置パターンです。
行数と列数で構成され、映像ソースの数や `max_rows`、`max_columns` の設定に基づいて自動的に決定されます。

### 映像ソース

合成の入力として使われる映像のメタデータファイル（JSON）とメディアファイルのことを指します。
レイアウト JSON の仕様の文脈では、
簡単のために「メタデータファイルのパス」のことを単に「映像ソース」と呼称することもあります。

メタデータファイルとしては、
Sora が各コネクションの録画毎に生成する `archive-*.json` を想定していますが、
Hisui はその中の、以下の情報を参照しています:

- **コネクション ID**: 配信者を識別するための ID
  - Sora の分割録画の際には、この ID が同一のメタデータファイルが複数生成されます
  - それらは自動的に連結して、同一のソースとして処理されます
- **開始時刻・終了時刻**: 映像が表示される時間範囲
  - 合成では録画開始時刻からのオフセット時間が使用されます
- **メディア形式**: メディアファイルのコンテナ形式（`webm` または `mp4`）
- **音声・映像の有無**: そのソースが音声や映像を含むかどうかの情報

レイアウト JSON で指定するのは、メタデータファイルのパスで、
それに対応するメディアファイルのパスは「メタデータファイルの拡張子を **メディア形式** で置き換えたもの」として決定されます。

以下はメタデータファイルの例です：

```json
{
  "connection_id": "M4WMN55P8QYD1BKF0MVWARVKXN",
  "format": "webm",
  "audio": true,
  "video": true,
  "start_time_offset": 0,
  "stop_time_offset": 600,
  ... 他の項目は Hisui は参照しないので省略 ...
}
```

この映像ソースは、コネクション ID `M4WMN55P8QYD1BKF0MVWARVKXN` で識別される配信者による、開始時刻 0 秒から終了時刻 600 秒（10 分間）の webm 形式の録画で、音声と映像の両方を含んでいることを示しています。

## リージョン処理の全体の流れ

各リージョンは、おおまかには以下の流れで処理されます:

1. 映像ソース一覧の決定
2. 各映像ソースの表示時間範囲の決定
3. グリッド構成の決定
4. 各映像ソースのセルへの割り当て
5. 各種解像度の決定
6. 枠線・位置の最終調整
7. トリム範囲の決定
8. 合成処理

以降では、このそれぞれについて詳しく説明していきます。

## 映像ソース一覧の決定方法

リージョンで使われる映像ソース一覧の決定は、以下の手順で行われます：

### 1. `video_sources` のワイルドカード解決

リージョンの `video_sources` で指定されたパスがワイルドカードを含む場合は、まずそれが解決されます:

- ファイル名部分に `*` を含むパスは、マッチする全てのファイルに展開されます
  - 例：`archive-*.json` は `archive-connection-id1.json`, `archive-connection-id2.json` 等にマッチします
- 展開後に重複するパスが存在する場合には、重複分は自動的に除去されます
- ワイルドカードを含まないパスは、そのままのパスとして扱われます

### 2. `video_sources_excluded` のワイルドカード解決と除外処理

除外パターンも同様にワイルドカード展開された後、`video_sources` から除外されます。

例えば、次のような指定の場合は、
全ての `archive-*.json` ファイルから `archive-presenter.json` を除いたファイルが対象として残ります。

```json
{
  "video_sources": ["archive-*.json"],
  "video_sources_excluded": ["archive-presenter.json"]
}
```

### 3. 分割録画の考慮

`video_sources` や `video_sources_excluded` に、同じ `connection_id` を持つ複数のメタデータファイルが存在する場合には、
一つのソースに属するものとして扱われます。

例えば、以下のような分割録画ファイルがある場合：

```
archive-user1-001.json (connection_id: USER1, 0-300秒)
archive-user1-002.json (connection_id: USER1, 300-600秒)
archive-user1-003.json (connection_id: USER1, 600-900秒)
```

`video_sources` で `["archive-user1-*.json"]` と指定されていたら、
これらは同じ `connection_id` を持つため、一つのソース（0-900 秒の連続した映像）として扱われます。

## 映像ソースの表示開始時刻と終了時刻の決定方法

各ソースの表示時間範囲は、以下のように決定されます：

- 一括録画の場合: メタデータファイルの `start_time_offset` と `stop_time_offset` の値をそのまま採用
- 分割録画の場合: コネクション ID が同じ全てのメタデータファイルの中で、最も早い開始時刻と最も遅い終了時刻を採用

## グリッドの構成（行列サイズ）の決定方法

各リージョン内でのグリッドの行数と列数は、映像ソースの数と制約設定に基づいて自動的に決定されます。
決定処理は以下の手順で行われます。

### リージョンで必要なセル数を算出

まず、そのリージョンの映像ソースを全て表示する場合に必要となるセルの数を、以下のように決定します:

1. 各映像ソースの開始時刻と終了時刻を元に、各時刻で同時に存在（表示）するソース数を計算
2. 「各時刻で同時に存在するソース数」の最大値を求めて「必要なセル数」とする
3. `cells_excluded` が指定されている場合には、そこで除外されたセルの分を「必要なセル数」に加算する
  - つまり `cells_excluded` で指定されたセルには「何も表示しない空ソース」が存在するものとして扱われる
  - 例：4 つの同時表示ソースがあり、2 つのセルが除外されている場合、6 つのセルが必要と判断される

なお `cells_excluded` で指定されたセルのインデックスが、実際のグリッドのセル数よりも大きい場合、
そのインデックスは単に無視されます。

例えば、以下のようなレイアウトを考えてみます：

```json
{
  "video_layout": {
    "main": {
      "video_sources": ["user1.json", "user2.json", "user3.json"],
      "max_rows": 2,
      "max_columns": 2,
      "cells_excluded": [1, 5, 8]
    }
  }
}
```

ここで、全ての映像ソースの表示時刻範囲が等しいものとすると、グリッドの構成は次のようになります:

```
┌──────┬──────┐
│User1 │ 除外 │  ← インデックスが 1 のセルだけが除外されている
├──────┼──────┤
│User2 │User3 │
└──────┴──────┘
```

インデックスが `5` および `8` のセルは、グリッドのセル数である 4 を超過しているため、
このレイアウトでは単に無視されます。

言いかえると「除外セルの指定を反映するためだけにグリッドのサイズを増やすことはない」ということになります。

### 2. 基本グリッドサイズの決定

次は、制約がない場合の理想的な行列数を以下の方針で決定します：
- 上で求めた「全ての映像ソースを表示するために必要なセル数」を全て配置できるグリッドにする
- できるだけ正方形に近い配置にする
- ただし、列数は行数よりも1つ多くても許容する

**例**: 5つのソースがある場合

```
理想的な配置: 2 行 × 3 列 = 6 セル (5 つのソースを収容可能)

┌─────┬─────┬─────┐
│Src1 │Src2 │Src3 │
├─────┼─────┼─────┤
│Src4 │Src5 │Empty│
└─────┴─────┴─────┘
```

### 3. 制約の適用

`max_rows` と `max_columns` の指定に基づいて調整を行います：

#### ケース 1: 制約内に収まる場合

「全ての映像ソースを表示するために必要なセル数」が `max_rows * max_columns` 以下であり、
制約を満たしている場合は、基本グリッドサイズをそのまま使用します。

#### ケース 2: 片方の制約のみ超過する場合

超過している側を制約値に調整し、もう片方を必要に応じて拡張します。

**例**: `max_columns = 2` の制約がある場合（5 つのソース）
```
調整後: 3行 × 2列 = 6セル

┌─────┬─────┐
│Src1 │Src2 │
├─────┼─────┤
│Src3 │Src4 │
├─────┼─────┤
│Src5 │Empty│
└─────┴─────┘
```

#### ケース 3: 両方の制約を超過する場合
正方形により近くなる方の制約を優先して調整します。

**例**: `max_rows = 2`, `max_columns = 2` の場合（5 つのソース）
```
制約適用後: 2 行 × 2 列 = 4 セル
（超過分のソースの扱いは、後述の reuse 設定によって決定される）

┌─────┬─────┐
│Src1 │Src2 │
├─────┼─────┤
│Src3 │Src4 │
└─────┴─────┘
```

## 各映像ソースのセルへの割り当て

グリッドの構成が決定された後は、各映像ソースの具体的なセルへの割り当てが行われるます。
ここでは、映像ソースの表示時間範囲とセルの再利用設定（`reuse`）を考慮して、ソースを配置するセルが決定されます。


なお、ソースとセルの対応は固定で、途中で変更されることはありません。

### 基本的な割り当て方針

映像ソースのセルへの割り当ては、以下の手順で行われます：

1. セルの初期状態を設定:
  - 利用可能なセルは「空き」状態に、除外されたセルは「除外」状態に設定
2. 映像ソースを開始時刻が早い順に処理する
  - 新規映像ソースは、その時点で一番インデックスが小さい「空き」状態のセルに割り当てる
  - 終了時刻に達したソースは、セルへの割り当てを解除して、セルを「空き」状態に戻す
3. 「空き」状態のセルがない時には `reuse` 設定に従って新規映像ソースの扱いを決定する

### 十分な空きセルがある場合の動作例

以下は 4 つのセル（2×2）に 3 つの映像ソースがある場合の基本的な動作例です：

```
時刻:     0----5----10---15---20
ソース A:      [==== A ====]
ソース B:           [=== B ===]
ソース C: [== C ==]

[セルの状態変化]
時刻 0:
┌──────┬──────┐
│  C   │      │
├──────┼──────┤
│      │      │
└──────┴──────┘

時刻 5:
┌──────┬──────┐
│  C   │  A   │
├──────┼──────┤
│      │      │
└──────┴──────┘

時刻 8:
┌──────┬──────┐
│      │  A   │  ← ソース C が終了してセル 0 が空きに
├──────┼──────┤
│      │      │
└──────┴──────┘

時刻 10:
┌──────┬──────┐
│      │  A   │
├──────┼──────┤
│  B   │      │  ← ソース B が開始して最初の空きセル(2) に割り当て
└──────┴──────┘

時刻 15:
┌──────┬──────┐
│      │      │  ← ソース A が終了してセル 1 が空きに
├──────┼──────┤
│  B   │      │
└──────┴──────┘

時刻 20:
┌──────┬──────┐
│      │      │
├──────┼──────┤
│      │      │  ← ソース B が終了して全セルが空きに
└──────┴──────┘
```

この例では、セルが十分にあるため、どのソースも競合することなく表示されています。

### reuse 設定による動作の違い

#### `reuse: "none"` の場合

セルの再利用を行わず、空きセルがなくなった時点で以降の映像ソースは表示されません。

```json
{
  "video_layout": {
    "main": {
      "video_sources": ["*.json"],
      "max_rows": 2,
      "max_columns": 2,
      "reuse": "none"
    }
  }
}
```

**動作例**：4つのセル（2×2）に5つの映像ソースがある場合
```
時刻:     0----5----10---15---20
ソースA:       [==== A ====]
ソースB:            [=== B ===]
ソースC:  [== C ==]
ソースD:                 [== D ==]
ソースE:  [======== E ========]  ← 表示されない（セルが不足）
```

この場合、最初の4つのソース（A, B, C, D）のみが表示され、ソースEは表示されません。

#### `reuse: "show_oldest"`（デフォルト）の場合

セルを再利用し、競合が発生した場合は開始時刻が早い映像ソースが優先されます。

**動作例**：2つのセル（1×2）に3つの映像ソースがある場合
```
時刻:     0----5----10---15---20
ソースA:       [==== A ====]
ソースB:            [=== B ===]
ソースC:                 [== C ==]

セル0: [空き] → A表示 → [空き] → C表示
セル1: [空き] → B表示 → [空き]
```

時刻10でソースAが終了すると、セル0が空きになり、時刻15から開始するソースCがそこに割り当てられます。

#### `reuse: "show_newest"` の場合

セルを再利用し、競合が発生した場合は開始時刻が遅い映像ソースが優先されます。

**動作例**：1つのセル（1×1）に2つの重複する映像ソースがある場合
```
時刻:     0----5----10---15---20
ソースA:  [======== A ========]
ソースB:       [==== B ====]

セル0: A表示 → B表示（優先） → A表示（復帰）
```

時刻5でソースBが開始すると、より新しいソースBが優先されてセル0に表示されます。
時刻15でソースBが終了すると、まだ継続中のソースAが再びセル0に表示されます。

### セルの除外機能

`cells_excluded` を使用することで、特定のセルを意図的に空にしておくことができます：

```json
{
  "video_layout": {
    "main": {
      "video_sources": ["*.json"],
      "max_rows": 2,
      "max_columns": 3,
      "cells_excluded": [1, 4]
    }
  }
}
```

この設定では、以下のようなレイアウトになります：

```
┌──────┬──────┬──────┐
│Src1  │ 除外 │Src2  │  ← インデックス1のセルが除外
├──────┼──────┼──────┤
│Src3  │ 除外 │Src4  │  ← インデックス4のセルが除外
└──────┴──────┴──────┘
```

**注意点**：
- 除外されたセルのインデックスがグリッドのセル数を超えている場合、そのインデックスは無視されます
- 除外セルはグリッドサイズの決定時に「空ソース」として扱われるため、必要なセル数の計算に含まれます

### 優先度システム

競合が発生した場合の表示優先度は、内部的な優先度値によって管理されます：

- **`show_oldest`**: 後から競合するソースの優先度を下げる（古いソースを優先）
- **`show_newest`**: 後から競合するソースの優先度を上げる（新しいソースを優先）

この優先度システムにより、同一セルに複数のソースが割り当てられた場合でも、適切な表示順序が維持されます。


## 解像度の決定方法

Hisui の映像合成において、最終的な出力映像の解像度は複数の段階を経て決定されます。
解像度は「全体解像度」、「リージョン解像度」、「セル解像度」の 3 つのレベルで考える必要があります。

### 全体解像度の決定方法

全体解像度は、合成後の映像全体のサイズを決定します。以下の優先順位で決定されます：

#### 1. `resolution` フィールドによる明示的指定

レイアウト JSON で `resolution` フィールドが指定されている場合、それが全体解像度として使用されます：

```json
{
  "resolution": "1920x1080",
  "video_layout": {
    "main": {
      "video_sources": ["*.json"]
    }
  }
}
```

指定可能な解像度の制約：
- 幅・高さともに 16 ピクセル以上 3840 ピクセル以下
- 幅・高さともに偶数値（奇数が指定された場合は自動的に偶数に丸められます）

#### 2. リージョンの配置からの自動計算

`resolution` が未指定の場合、各リージョンの位置とサイズから必要な解像度が自動計算されます。
具体的には、全てのリージョンが収まる最小の解像度が選択されます：

```json
{
  "video_layout": {
    "main": {
      "video_sources": ["*.json"],
      "width": 640,
      "height": 480,
      "x_pos": 100,
      "y_pos": 50
    },
    "sub": {
      "video_sources": ["sub.json"],
      "width": 200,
      "height": 150,
      "x_pos": 800,
      "y_pos": 300
    }
  }
}
```

上記の例では、`sub` リージョンの右端が `800 + 200 = 1000` ピクセル、下端が `300 + 150 = 450` ピクセルとなるため、全体解像度は最低でも `1000×450` ピクセル以上になります。

#### 3. 音声のみの場合

映像リージョンが存在しない（音声のみの合成）場合は、最小解像度 16×16 ピクセルが使用されます。

### リージョン解像度の決定方法

各リージョンのサイズは、以下の優先順位で決定されます：

#### 1. `width` / `height` による明示的指定

リージョンの `width` および `height` が指定されている場合、それがそのまま使用されます：

```json
{
  "video_layout": {
    "main": {
      "video_sources": ["*.json"],
      "width": 640,
      "height": 480
    }
  }
}
```

#### 2. `cell_width` / `cell_height` からの計算

セルサイズが指定されている場合、リージョンサイズはグリッドの構成から逆算されます：

```json
{
  "video_layout": {
    "main": {
      "video_sources": ["*.json"],
      "cell_width": 320,
      "cell_height": 240,
      "max_columns": 2,
      "max_rows": 2
    }
  }
}
```

この場合のリージョンサイズ計算：

```
リージョン幅 = セル幅 × 列数 + 内側枠線 + 外側枠線
           = 320 × 2 + 2 × (2-1) + 4
           = 640 + 2 + 4 = 646 ピクセル

リージョン高さ = セル高さ × 行数 + 内側枠線 + 外側枠線
            = 240 × 2 + 2 × (2-1) + 4
            = 480 + 2 + 4 = 486 ピクセル
```

TODO: 枠線周りに言及しないと上の式がよく分からない（そもそも詳細な式は不要かも）

**注意**: `width` と `cell_width` を同時に指定することはできません。同様に、`height` と `cell_height` も同時指定できません。

#### 3. 全体解像度からの自動計算

リージョンサイズが未指定の場合、全体解像度とリージョンの位置から自動計算されます：

```json
{
  "resolution": "1920x1080",
  "video_layout": {
    "main": {
      "video_sources": ["*.json"],
      "x_pos": 100,
      "y_pos": 50
      // width, height は未指定
    }
  }
}
```

上記の例では、リージョンサイズは以下のようになります：
- 幅: `1920 - 100 = 1820` ピクセル
- 高さ: `1080 - 50 = 1030` ピクセル

### セル解像度の決定方法

各セル（グリッド内の個別の映像表示領域）のサイズは、リージョンサイズとグリッドの行列数から計算されます：

#### 基本的な計算方法

1. **外側枠線の除去**: リージョン全体から外周の枠線部分を除いた実際のグリッド領域を計算
2. **内側枠線の除去**: セル間の境界線部分を除いたセル表示領域を計算
3. **セルサイズの決定**: 残った領域をグリッドの行列数で均等分割

#### 枠線の扱い

- **内側枠線**: セル間の境界線（固定で 2 ピクセル）
- **外側枠線**: リージョンの外周の枠線（余剰ピクセルを均等分割して決定）

#### 具体例

2×2 グリッドで 646×486 ピクセルのリージョンの場合：

```
1. 内側枠線の計算:
   - 水平方向: 2 × (2列 - 1) = 2 ピクセル
   - 垂直方向: 2 × (2行 - 1) = 2 ピクセル

2. セル表示領域の計算:
   - 幅: 646 - 2 = 644 ピクセル（外側枠線を後で調整）
   - 高さ: 486 - 2 = 484 ピクセル（外側枠線を後で調整）

3. 各セルのサイズ:
   - セル幅: (644 - 2) ÷ 2 = 321 ピクセル → 320 ピクセル（偶数調整）
   - セル高さ: (484 - 2) ÷ 2 = 241 ピクセル → 240 ピクセル（偶数調整）

4. 外側枠線の決定:
   - 水平方向: (646 - (320×2 + 2)) ÷ 2 = 2 ピクセル
   - 垂直方向: (486 - (240×2 + 2)) ÷ 2 = 2 ピクセル
```

### 解像度決定の実際の流れ

解像度は以下の順序で段階的に決定されます：

#### 1. グリッド構成の決定

まず、各リージョンで必要となる映像ソース数とグリッドの制約（`max_rows`、`max_columns`）から、実際のグリッドの行列数が決定されます。

#### 2. セルサイズ指定の処理

`cell_width` または `cell_height` が指定されている場合、それらの値とグリッドの行列数からリージョンサイズが逆算されます。

#### 3. 全体解像度の確定

- `resolution` フィールドが指定されている場合はその値を使用
- 未指定の場合は、全てのリージョンの位置とサイズから必要な解像度を計算

#### 4. リージョンサイズの調整

- 明示的に指定されたリージョンサイズを検証
- 未指定のリージョンは全体解像度から自動計算

#### 5. 最終的なセル解像度の計算

確定したリージョンサイズとグリッド構成から、各セルの最終的なサイズを計算します。

#### 6. 制約チェック

全ての解像度値が以下の制約を満たしているかを確認：
- 幅・高さが 16 ピクセル以上 3840 ピクセル以下
- 偶数値であること
- リージョンが全体解像度の範囲内に収まっていること

このように、レイアウト JSON の設定に応じて、柔軟かつ段階的に各レベルの解像度が決定されます。

## trim の扱い

`trim` 機能は、配信者が存在しない期間を合成結果から自動的に除去する機能です。

TODO: 映像だけでなく音声も関係することを注記しておく

### 基本的な動作

`trim: true` を指定すると、音声ないし映像ソースが全く存在しない時間帯は、合成結果に含まれなくなります。

```json
{
  "audio_sources": ["archive-*.json"],
  "video_layout": {
    "main": {
      "video_sources": ["archive-*.json"]
    }
  },
  "trim": true
}
```

### 判断基準について

**重要**: `trim` の判断基準は、ソースの映像・音声の内容とは関係なく、**ソースが該当期間に存在するかどうか**のみです。

具体的には、以下の条件で判断されます：

- **トリム対象となる期間**: 全てのソース（音声・映像を問わず）の時間範囲外の期間
- **保持される期間**: 少なくとも一つのソースが存在する期間

### 実例

以下のような録画状況を考えてみます：

```
時刻:     0----5----10---15---20---25---30
ソースA:       [====== A archive ======]
ソースB:                 [== B archive ==]
ソースC:  [=== C archive ===]
```

この場合の動作：

- **時刻 0-5**: ソース C のみ存在 → **保持される**
- **時刻 5-10**: ソース A, C が存在 → **保持される**
- **時刻 10-15**: ソース A, B が存在 → **保持される**
- **時刻 15-20**: ソース B のみ存在 → **保持される**
- **時刻 20-30**: どのソースも存在しない → **トリムされる**

### 映像・音声の内容は無関係

注意すべき点として、以下のような状況でも該当期間は保持されます：

- ソースの映像が真っ黒（カメラオフ）でも、ソース自体が存在すれば保持
- ソースの音声が無音でも、ソース自体が存在すれば保持
- ソースが一時的に接続不良で映像・音声が途切れても、ソース自体が存在すれば保持

つまり、`trim` は「配信者の参加/離脱」に基づいてトリミングを行い、「配信者が何を配信しているか」の内容は考慮しません。
