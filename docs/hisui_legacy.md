# レガシー版 Hisui からのマイグレーションガイド

このドキュメントは [C++ で実装されている 2024.1.1 以前の Hisui][hisui-legacy] から Rust で
書き直された 2025.1.0 の Hisui への移行方法を説明するものです。
このドキュメントでは、前者と後者をそれぞれ「レガシー Hisui」および「新 Hisui」と呼称します。

新 Hisui は実装言語が変更されただけではなく、さまざまな点でレガシー Hisui とは異なっています。
互換性は可能な限りを維持されてはいますが、レガシー Hisui のユーザーは
新 Hisui に切り替える前に、このドキュメントに一通り目を通すことをおすすめします。

[hisui-legacy]: https://github.com/shiguredo/hisui-legacy

## 基本的な移行方法

新 Hisui は、レガシー Hisui との互換性維持を目的とした [`hisui legacy`](./command_legacy.md) コマンドを提供しています。
そのため通常は、以下のように、レガシー Hisui で使用していた引数群の前に `legacy` を付与すれば、そのまま動作するはずです。

```console
// レガシー Hisui
$ hisui -f /path/to/report.json ...その他の引数...

// 新 Hisui
// => `hisui` の直後に `legacy` を追加する
$ hisui legacy -f /path/to/report.json ...その他の引数...
```

しかし `hisui legacy` コマンドも 100% の互換性がある訳ではないので、注意が必要です。
以降では、具体的な相違点を記載します。

## 相違点: 廃止された機能

## 相違点: 挙動が変わった機能

## その他の相違点

MEMO:
- コマンドラインインタフェースの差異
  - 実験的なコマンドライン引数は完全に廃止
  - それ以外の引数で新 Hisui で使っていないものは「指定できるけれど（警告ログを出して）無視する」という形
    - TODO: 列挙する: `--out-container`, `--mp4-muxer`, `--dir-for-faststart`, `--h264-encoder`, etc
  - 軽微なもの:
    - ログ内容
    - プログレスバー
- コーデック
  - H.265 対応（macOS のみ）
- コンテナフォーマット
  - 入力で mp4 に対応
  - 出力で wemb 対応をドロップ
- デフォルトの出力ファイルの拡張子
  - レガシーでは音声のみの場合は `.mp4a` になっていた
  - 新では常に `.mp4` (legacy コマンドは例外)
- 使用エンコーダー・デコーダーの変更
- 分割録画に対応
- macOS 対応の追加
- レイアウト周りの差異
  - width / height の制限が「4 の倍数」から「2 の倍数」と緩くなった (後方互換)
  - cell_width / cell_height の追加 (後方互換)
    - モチベーション: レガシー hisui で report.json を指定した場合の挙動に近いものを、レイアウトで表現できるようにするため
    - 同じ理由で new hisui では `resolution` の指定がオプショナルになっている
  - `format` がなくなった（出力が mp4 のみのため）
  - セルへのソースの割り当て順序
    - new hisui だと常に開始時刻順で配置している
  - レガシーの場合も基本は同様だけど、以下のケースだけ挙動が異なる
    - 条件: `max_columns` と `max_rows` の両方が指定されていて、かつ、ソースの数が `max_columns * max_rows` よりも多い
    - 挙動: まずソースリストの先頭から `max_columns * max_rows` が選択されて、その後は開始時刻順で配置される
  - ワイルドカードの扱いが少し柔軟になった
    - レイアウトファイルと同じディレクトリにあるファイルのみが指定可能、という制約がなくなった
    - 各種コマンドの `ROOT_DIR` を起点として、それ以下の任意のパスが指定可能
  - リージョン内での同じソースの複数指定
    - レガシーではそのまま複数として扱われる
    - new hisuiではユニークがとられる
- 新規追加機能
  - TODO
- メディアファイルの探索方法
  - 旧: `archive-*.json` の `filename` や `file_path` といくつかのヒューリスティックを組み合わせていた
  - 新: `archive-*.json` の拡張子違いでメディアファイルがある、という前提
- 要検討:
  - `trim=false` の場合の冒頭部分の扱い
    - レガシー互換で先頭を除去するようにしたら「録画開始後に配信者が遅れてきた場合」に黒画面をなくせる
    - ただし、録画尺が実際（レポートファイルに記載のものと）ずれてしまう可能性があるのを防ぐ方法がなくなるので、時刻合わせにシビアな用途で使いにくくなりそう
