# レガシー版 Hisui からのマイグレーションガイド

このドキュメントは [C++ で実装されている 2024.1.1 以前の Hisui][hisui-legacy] から Rust で
書き直された 2025.1.0 の Hisui への移行方法を説明するものです。
このドキュメントでは、前者と後者をそれぞれ「レガシー Hisui」および「新 Hisui」と呼称します。

新 Hisui は実装言語が変更されただけではなく、さまざまな点でレガシー Hisui とは異なっています。
互換性は可能な限りを維持されてはいますが、レガシー Hisui のユーザーは
新 Hisui に切り替える前に、このドキュメントに一通り目を通すことをおすすめします。

[hisui-legacy]: https://github.com/shiguredo/hisui-legacy

## `hisui legacy` サブコマンドを用いた移行方法

新 Hisui は、サブコマンド方式のコマンドラインインタフェースを採用しています。
そのため、レガシー Hisui とは異なり、コマンドラインの第一引数はサブコマンドの名前となっています。

レガシー Hisui との互換性維持を目的としたものとしては、[`hisui legacy`](./command_legacy.md) サブコマンドが提供されています。
通常は以下のように、レガシー Hisui で使用していた引数群の前に `legacy` を付与すれば、新 Hisui でもそのまま動作するはずです。

```console
// レガシー Hisui
$ hisui -f /path/to/report.json ...その他の引数...

// 新 Hisui
// => `hisui` の直後に `legacy` を追加する
$ hisui legacy -f /path/to/report.json ...その他の引数...
```

しかし `hisui legacy` サブコマンドも 100% の互換性が維持されている訳ではないので、注意が必要です。
本ドキュメントの後半では、レガシー Hisui と新 Hisui の具体的な相違点を記載していますので、そちらもご参照ください。

なお `hisui legacy` サブコマンドは将来的に廃止予定となっているため、
長期的には、次に説明する `hisui compose` サブコマンドへの移行を推奨しています。

## `hisui compose` サブコマンドへの移行方法

[`hisui compose`](./command_compose.md) サブコマンドは「レガシー Hisuiでのレイアウトファイルを指定した合成」を中心に据えて、
その分、コマンドライン引数をシンプルにしたものと考えることができます。

レイアウトファイルの互換性は維持されているので、レガシー Hisui ですでにレイアウトファイルを使って合成を行っていた場合には、
基本的には、次のような単純な修正で移行できます。

```console
// レガシー Hisui
$ hisui --layout /path/to/layout.json 

// 新 Hisui
// => `hisui` の直後に `compose` を追加する
// => レポートファイルなどが配置されているディレクトリを指定する
$ hisui compose --layout /path/to/layout.json /path/to/合成対象の録画ファイルが配置されているディレクトリ/
```

`hisui compose` サブコマンドで `--layout` オプションを省略した場合にはデフォルトレイアウトでの合成が行われます。
デフォルトレイアウトは、レガシー Hisui でレポートファイルを指定した場合のレイアウトと同じになっているため、
レガシー Hisui でレポートファイル指定で合成を行っていた場合には、
次のように `--layout` オプションの指定を省略することで、同じ結果が得られます。

```console
// レガシー Hisui
$ hisui -f /path/to/report.json ...その他の引数...

// 新 Hisui
// => `hisui` の直後に `compose` を追加する
// => レポートファイルなどが配置されているディレクトリを指定する
// => `--layout` オプションは指定しない
$ hisui compose /path/to/合成対象の録画ファイルが配置されているディレクトリ/
```

なお `hisui compose` サブコマンドでは、レガシー Hisui や新 Hisui の `hisui legacy` サブコマンドとは異なり、
エンコードコーデックやエンコードパラメーターなどを、コマンドライン引数ではなくレイアウトファイルの中で指定するようになっています。
そのため、もしレガシー Hisui でそれらを指定していた場合には移行時に注意が必要となります。

レイアウト機能自体の詳細については [レイアウト機能のドキュメント](./layout.md) をご参照ください。

---

これ以降では、レガシー Hisui と新 Hisui の相違点について説明します。

## 相違点: 廃止された機能

本セクションでは、新 Hisui では廃止されて使えなくなった機能について説明します。

### 実験的なコマンドライン引数は廃止

レガシー Hisui で実験的な扱いであったり、ドキュメントに記載がなかったりした引数は、新 Hisui では完全に廃止されました。
`hisui legacy` サブコマンドで、これらの引数が指定された場合には、コマンドライン引数のパース時にエラーになります。

### 合成結果の WebM 形式での出力は廃止

出力形式としては MP4 のみのサポートとなりました。
それに伴い `--out-container` 引数は非推奨となりました（`hisui legacy` サブコマンドで指定しても無視されます）。
また、レイアウトファイルで `format` が指定されても単に無視されます。

### OneVPL を使った H.264 エンコードおよびデコードの廃止

OneVPL 対応は廃止され、それに伴い `--h264-encoder` 引数は非推奨となりました（`hisui legacy` サブコマンドで指定しても無視されます）。

Linux 環境で、H.264 のエンコードおよびデコードを行うためには OpenH264 が必須となります。
なお macOS 環境では Apple Video Toolbox を使った H.264 ストリーム処理をサポートしています。

### `--video-codec-engines` コマンドライン引数は廃止

利用可能なコーデック一覧を取得する方法としては、代わりに [list-codecs](./command_list_codecs.md) サブコマンドが導入されました。
それに伴い `--video-codec-engines` 引数は廃止されました（`hisui legacy` サブコマンドで指定しても無視されます）。

## 相違点: 挙動が変わった機能

本セクションでは、新 Hisui での挙動の変更点について説明します。

### MP4 ファイル出力が常に faststart 方式で行われるようになった

faststart 方式は「MP4 の再生に必要なメタデータをファイルの先頭付近に配置することで再生開始までの時間を短くする」というものです。

新 Hisui では、常にこの方式を採用し、またその際に（レガシー Hisuiと異なり）一時ファイルを利用しなくなりました。
それに伴い `--mp4-muxer` および `--dir-for-faststart` 引数は不要となったため、非推奨となりました（`hisui legacy` サブコマンドで指定しても無視されます）。

### AV1 デコーダーの変更

AV1 ストリーム用のデコーダーが SVT-AV1 から dav1d に変更されました。

### ログメッセージとプログレスバーの内容の変更

ログメッセージとプログレスバーの出力内容には互換性がありません。

### 音声のみ合成でのデフォルト出力ファイルの拡張子の変更

レガシー Hisui で出力ファイルの名前を省略した場合は、
「音声のみの場合は `.mp4a`」で「それ以外の場合は `.mp4`」という拡張子になっていました。

新 Hisui でも `hisui legacy` サブコマンドではその挙動を踏襲していますが、
`hisui compose` サブコマンドでは、デフォルト出力ファイルの拡張子は常に `.mp4` となります。

### デフォルトエンコードパラメーターの変更

後述するように、新 Hisui ではエンコードパラメーターを以前よりも細かく指定できるようになりました。
それに伴ってデフォルトで使用されるエンコードパラメーターも調整されており、レガシー Hisui とは異なるものとなっています。

レガシー Hisui でのデフォルトエンコードパラメーターは明文化されているものではなかったので、ここで詳細に変更点を列挙することはしませんが、
新 Hisui でのデフォルトパラメーターについては [layout-examples/compose-default.jsonc](../layout-examples/compose-default.jsonc) ファイルをご参照ください。

### レイアウトファイルでの解像度指定の制限が少し緩くなった

レガシー Hisui では「4 の倍数」という制限だったのが、新 Hisui では「2 の倍数」と緩和された。

### ひとつのリージョンの中で同じソースが複数回指定された場合挙動の変更

レガシー Hisui では、別々のソースとして扱われますが、新 Hisui では同じリージョン内での重複したソースはひとつにまとめられます。

### メディアファイルの探索方法の変更

レガシー Hisui では、`archive-*.json` の中身に記載されているパスの情報などを考慮して対応するメディアファイルのパスを決定していました。
新 Hisui では、`archive-*.json` の中身は考慮せずに、単純に、指定された `archive-*.json` のパスの
拡張子を（`.mp4` ないし `.webm` に）置換することでメディアファイルのパスを決定しています。

## 相違点: 追加された機能

### H.265 対応が追加された（macOS のみ）

### 分割録画に対応した

### MP4 ファイル入力に対応した

### macOS でのビルドに対応した

### エンコードパラメーターの細かい指定と自動調整に対応した

### Hisui 自体のマルチスレッド実行に対応した

### 統計情報の出力に対応した

MEMO:

- レイアウト周りの差異
  - cell_width / cell_height の追加 (後方互換)
    - モチベーション: レガシー hisui で report.json を指定した場合の挙動に近いものを、レイアウトで表現できるようにするため
    - 同じ理由で new hisui では `resolution` の指定がオプショナルになっている
  - セルへのソースの割り当て順序
    - new hisui だと常に開始時刻順で配置している
  - レガシーの場合も基本は同様だけど、以下のケースだけ挙動が異なる
    - 条件: `max_columns` と `max_rows` の両方が指定されていて、かつ、ソースの数が `max_columns * max_rows` よりも多い
    - 挙動: まずソースリストの先頭から `max_columns * max_rows` が選択されて、その後は開始時刻順で配置される
  - ワイルドカードの扱いが少し柔軟になった
    - レイアウトファイルと同じディレクトリにあるファイルのみが指定可能、という制約がなくなった
    - 各種コマンドの `ROOT_DIR` を起点として、それ以下の任意のパスが指定可能
  - `border_pixels`

