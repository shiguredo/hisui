# レガシー版 Hisui について

MEMO:
- コマンドラインインタフェースの差異
  - 実験的なコマンドライン引数は完全に廃止
  - それ以外の引数で新 Hisui で使っていないものは「指定できるけれど（警告ログを出して）無視する」という形
    - TODO: 列挙する: `--out-container`, `--mp4-muxer`, `--dir-for-faststart`, `--h264-encoder`, etc
  - 軽微なもの:
    - ログ内容
    - プログレスバー
- コーデック
  - H.265 対応（macOS のみ）
- コンテナフォーマット
  - 入力で mp4 に対応
  - 出力で wemb 対応をドロップ
- デフォルトの出力ファイルの拡張子
  - レガシーでは音声のみの場合は `.mp4a` になっていた
  - 新では常に `.mp4`
- 使用エンコーダー・デコーダーの変更
- 分割録画に対応
- macOS 対応の追加
- レイアウト周りの差異
  - width / height の制限が「4 の倍数」から「2 の倍数」と緩くなった (後方互換)
  - cell_width / cell_height の追加 (後方互換)
    - モチベーション: レガシー hisui で report.json を指定した場合の挙動に近いものを、レイアウトで表現できるようにするため
  - `format` がなくなった（出力が mp4 のみのため）
  - `reuse: Cell へのソースの配置の仕方を指定します。 video_sources での指定の最初から順に配置していきます。`
    - new hisui だと開始時刻順で配置している
    - 指定順だと、セルへの割り当てを細かくユーザーが制御できる反面、ワイルドカード指定との相性が悪そう
    - 「基本は指定順を守るけど、ワイルドカード部分については、典型結果を開始順でソートする」くらいが折衷案か
  - ワイルドカードの扱いが少し柔軟になった
    - レイアウトファイルと同じディレクトリにあるファイルのみが指定可能、という制約がなくなった
    - 各種コマンドの `ROOT_DIR` を起点として、それ以下の任意のパスが指定可能
  - trim が省略可能かどうか、省略可能ならそのデフォルト値
    - 新は省略可能でデフォルト false
- 新規追加機能
  - TODO
- メディアファイルの探索方法
  - 旧: `archive-*.json` の `filename` や `file_path` といくつかのヒューリスティックを組み合わせていた
  - 新: `archive-*.json` の拡張子違いでメディアファイルがある、という前提
- 要検討:
  - `trim=false` の場合の冒頭部分の扱い
    - レガシー互換で先頭を除去するようにしたら「録画開始後に配信者が遅れてきた場合」に黒画面をなくせる
    - ただし、録画尺が実際（レポートファイルに記載のものと）ずれてしまう可能性があるのを防ぐ方法がなくなるので、時刻合わせにシビアな用途で使いにくくなりそう
